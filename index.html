<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="theme-color" content="#007bff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="å£½å¸æœ—è¨ˆæ•¸æ©Ÿ" />
    <meta name="description" content="é‚Šé£Ÿé‡é‚Šè¨ˆæ•¸ï¼Œå³æ™‚çŸ¥é“ä½ é£Ÿå·¦å¹¾éŒ¢! ğŸ£" />
    <link rel="manifest" href="manifest.json" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23007bff' width='192' height='192'/><text x='96' y='120' font-size='100' text-anchor='middle' fill='white' font-family='Arial'>ğŸ£</text></svg>"
    />
    <link
      rel="apple-touch-icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23007bff' width='180' height='180' rx='40'/><text x='90' y='135' font-size='90' text-anchor='middle' fill='white' font-family='Arial'>ğŸ£</text></svg>"
    />
    <title>å£½å¸éƒè¨ˆæ•¸æ©Ÿ</title>
    <style>
      :root {
        --color-red: #d32f2f;
        --color-silver: #9e9e9e;
        --color-gold: #ffb300;
        --color-black: #212121;
        --color-primary: #007bff;
        --color-bg: #f5f5f5;
        --color-text: #333;
        --color-text-secondary: #666;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: var(--color-bg);
        padding: 0;
        padding-bottom: max(180px, calc(180px + env(safe-area-inset-bottom)));
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }

      /* Sticky Header - Cover Dynamic Island */
      .header {
        position: sticky;
        top: 0;
        background: white;
        padding: 16px 20px;
        padding-top: max(12px, env(safe-area-inset-top));
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        z-index: 90;
      }

      h1 {
        text-align: center;
        color: var(--color-text);
        font-size: 1.3rem;
        margin: 0;
        font-weight: 600;
      }

      /* å¡ç‰‡æ¨£å¼ */
      .card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin: 0 20px 15px 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      /* é¡è‰²è­˜åˆ¥æ¢ */
      .color-indicator {
        width: 10px;
        height: 50px;
        border-radius: 5px;
        margin-right: 15px;
        flex-shrink: 0;
      }

      .red {
        background-color: var(--color-red);
      }
      .silver {
        background-color: var(--color-silver);
      }
      .gold {
        background-color: var(--color-gold);
      }
      .black {
        background-color: var(--color-black);
      }

      .info {
        flex-grow: 1;
      }

      .price-label {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--color-text);
      }

      /* æŒ‰éˆ•æ§åˆ¶å€ */
      .controls {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .ctrl-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: none;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: all 0.15s ease;
        -webkit-user-select: none;
        user-select: none;
      }

      .btn-minus {
        background-color: #e0e0e0;
        color: #757575;
      }

      .btn-minus:active {
        background-color: #d0d0d0;
        transform: scale(0.95);
      }

      .btn-plus {
        background-color: var(--color-primary);
        color: white;
      }

      .btn-plus:active {
        background-color: #0056b3;
        transform: scale(0.95);
      }

      .count-display {
        font-size: 1.3rem;
        font-weight: bold;
        width: 36px;
        text-align: center;
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 6px;
        transition: background-color 0.2s ease;
      }

      .count-display:active {
        background-color: #e8e8e8;
      }

      .count-input-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease;
      }

      .count-input-dialog {
        background: white;
        border-radius: 20px;
        padding: 30px 20px;
        width: 90%;
        max-width: 300px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .count-input-dialog h3 {
        margin: 0 0 20px 0;
        font-size: 1.1rem;
        text-align: center;
        color: var(--color-text);
      }

      .count-input-dialog input {
        width: 100%;
        padding: 12px;
        font-size: 1.2rem;
        border: 2px solid var(--color-primary);
        border-radius: 10px;
        text-align: center;
        margin-bottom: 15px;
        box-sizing: border-box;
      }

      .count-input-dialog input:focus {
        outline: none;
        border-color: #0056b3;
        box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.2);
      }

      .count-input-buttons {
        display: flex;
        gap: 10px;
      }

      .count-input-buttons button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-cancel {
        background-color: #e0e0e0;
        color: #666;
      }

      .btn-cancel:active {
        background-color: #d0d0d0;
      }

      .btn-confirm {
        background-color: var(--color-primary);
        color: white;
      }

      .btn-confirm:active {
        background-color: #0056b3;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* ç‰¹åˆ¥æ–™ç†å€åŸŸ */
      .section-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--color-text);
        margin: 25px 20px 15px 20px;
        padding: 10px 0;
        border-bottom: 2px solid var(--color-primary);
      }

      /* è¼¸å…¥å…¶ä»–é‡‘é¡ */
      .custom-input {
        width: calc(100% - 40px);
        margin: 0 20px;
        padding: 12px;
        font-size: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-top: 10px;
      }

      .add-item-btn {
        width: calc(100% - 40px);
        margin: 15px 20px;
        padding: 14px 20px;
        font-size: 1rem;
        background: transparent;
        color: var(--color-primary);
        border: 2px solid var(--color-primary);
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        letter-spacing: 0.5px;
      }

      .add-item-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: rgba(0, 123, 255, 0.08);
        transition: left 0.4s ease;
        z-index: -1;
      }

      .add-item-btn:hover {
        background: rgba(0, 123, 255, 0.08);
        border-color: #0056b3;
        color: #0056b3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
      }

      .add-item-btn:active {
        background: rgba(0, 123, 255, 0.12);
        border-color: #003d82;
        color: #003d82;
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0, 123, 255, 0.1);
      }

      .add-item-btn::before:hover {
        left: 100%;
      }

      .custom-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        margin: 8px 0;
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
      }

      .custom-item-info {
        flex-grow: 1;
      }

      .custom-item-name {
        font-size: 0.9rem;
        color: #999;
        margin-bottom: 4px;
      }

      .custom-item-amount {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--color-text);
      }

      .custom-item-delete {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background-color: #e0e0e0;
        color: #757575;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.15s ease;
        flex-shrink: 0;
        margin-left: 10px;
      }

      .custom-item-delete:active {
        background-color: #d0d0d0;
      }

      /* é‡ç½®æŒ‰éˆ• */
      .reset-container {
        text-align: center;
        margin: 25px 20px 20px 20px;
      }

      .reset-btn {
        background-color: white;
        border: 1px solid var(--color-red);
        color: var(--color-red);
        padding: 10px 30px;
        font-size: 1rem;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
      }

      .reset-btn:active {
        background-color: var(--color-red);
        color: white;
      }

      /* åº•éƒ¨å›ºå®šçµç®—æ¬„ - Safe Area é©é… */
      .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.15);
        padding: 15px 20px;
        padding-bottom: max(15px, env(safe-area-inset-bottom));
        border-radius: 16px 16px 0 0;
        z-index: 100;
        backdrop-filter: blur(10px);
      }

      .total-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }

      .total-label {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
        margin-bottom: 4px;
      }

      .final-price-container {
        text-align: right;
      }

      .final-price {
        font-size: 2rem;
        font-weight: bold;
        color: var(--color-red);
        line-height: 1;
      }

      .service-charge {
        font-size: 0.8rem;
        color: #888;
        margin-top: 5px;
        text-align: center;
      }

      /* Modal æ¨£å¼ */
      dialog {
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        max-width: 95vw;
        max-height: 80vh;
        padding: 0;
        animation: slideUp 0.3s ease-out;
      }

      dialog::backdrop {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(3px);
      }

      @keyframes slideUp {
        from {
          transform: translateY(100px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        background: white;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.3rem;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-body {
        max-height: calc(80vh - 100px);
        overflow-y: auto;
        padding: 10px;
        padding-bottom: 20px;
      }

      .modal-category {
        font-weight: bold;
        font-size: 1rem;
        color: var(--color-text);
        background: #f5f5f5;
        padding: 12px 12px 8px 12px;
        margin-top: 12px;
        border-bottom: 2px solid var(--color-primary);
      }

      .modal-category:first-child {
        margin-top: 0;
      }

      .modal-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
      }

      .modal-item-info {
        flex-grow: 1;
      }

      .modal-item-name {
        font-weight: 500;
        font-size: 1rem;
        color: var(--color-text);
      }

      .modal-item-price {
        font-size: 0.9rem;
        color: var(--color-primary);
        font-weight: bold;
      }

      .modal-item-controls {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .modal-item-count {
        width: 30px;
        text-align: center;
        font-weight: bold;
        font-size: 1.1rem;
      }

      .small-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: all 0.15s ease;
      }

      .small-btn-minus {
        background-color: #f0f0f0;
        color: #888;
      }

      .small-btn-minus:active {
        background-color: #e0e0e0;
      }

      .small-btn-plus {
        background-color: var(--color-primary);
        color: white;
      }

      .small-btn-plus:active {
        background-color: #0056b3;
      }

      /* Scrollbar æ¨£å¼ */
      .modal-body::-webkit-scrollbar {
        width: 6px;
      }

      .modal-body::-webkit-scrollbar-track {
        background: transparent;
      }

      .modal-body::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 3px;
      }

      .modal-body::-webkit-scrollbar-thumb:hover {
        background: #999;
      }
    </style>
  </head>
  <body>
    <!-- Sticky Header -->
    <div class="header">
      <h1>ğŸ£ é¦™æ¸¯å£½å¸éƒè¨ˆæ•¸æ©Ÿ</h1>
    </div>

    <!-- é¡è‰²ç¢Ÿå€åŸŸ -->
    <div class="section-title">ğŸ½ï¸ é¡è‰²ç¢Ÿ (æŒ‰æ•¸å­—å¯äººæ‰‹è¼¸å…¥æ•¸é‡)</div>

    <div class="card">
      <div class="color-indicator red"></div>
      <div class="info">
        <div class="price-label">ç´…ç¢Ÿ $12</div>
      </div>
      <div class="controls">
        <button class="ctrl-btn btn-minus" onclick="updateCount('red', -1)">
          âˆ’
        </button>
        <span
          id="red-count"
          class="count-display"
          onclick="openCountInputModal('red')"
          >0</span
        >
        <button class="ctrl-btn btn-plus" onclick="updateCount('red', 1)">
          +
        </button>
      </div>
    </div>

    <div class="card">
      <div class="color-indicator silver"></div>
      <div class="info">
        <div class="price-label">éŠ€ç¢Ÿ $17</div>
      </div>
      <div class="controls">
        <button class="ctrl-btn btn-minus" onclick="updateCount('silver', -1)">
          âˆ’
        </button>
        <span
          id="silver-count"
          class="count-display"
          onclick="openCountInputModal('silver')"
          >0</span
        >
        <button class="ctrl-btn btn-plus" onclick="updateCount('silver', 1)">
          +
        </button>
      </div>
    </div>

    <div class="card">
      <div class="color-indicator gold"></div>
      <div class="info">
        <div class="price-label">é‡‘ç¢Ÿ $22</div>
      </div>
      <div class="controls">
        <button class="ctrl-btn btn-minus" onclick="updateCount('gold', -1)">
          âˆ’
        </button>
        <span
          id="gold-count"
          class="count-display"
          onclick="openCountInputModal('gold')"
          >0</span
        >
        <button class="ctrl-btn btn-plus" onclick="updateCount('gold', 1)">
          +
        </button>
      </div>
    </div>

    <div class="card">
      <div class="color-indicator black"></div>
      <div class="info">
        <div class="price-label">é»‘ç¢Ÿ $27</div>
      </div>
      <div class="controls">
        <button class="ctrl-btn btn-minus" onclick="updateCount('black', -1)">
          âˆ’
        </button>
        <span
          id="black-count"
          class="count-display"
          onclick="openCountInputModal('black')"
          >0</span
        >
        <button class="ctrl-btn btn-plus" onclick="updateCount('black', 1)">
          +
        </button>
      </div>
    </div>

    <!-- ç‰¹åˆ¥æ–™ç†å€åŸŸ -->
    <div class="section-title">âœ¨ ç‰¹åˆ¥æ–™ç†</div>

    <div class="card">
      <div class="info">
        <div class="price-label">ç‰¹åˆ¥æ–™ç†menu</div>
        <div style="font-size: 0.9rem; color: #999; margin-top: 4px;">
          é»æ“ŠæŸ¥çœ‹å…¨éƒ¨ç‰¹åˆ¥æ–™ç†
        </div>
      </div>
      <button
        class="ctrl-btn btn-plus"
        onclick="openSpecialDishesModal()"
        style="margin-left: auto;"
      >
        +
      </button>
    </div>

    <!-- ç‰¹åˆ¥æ–™ç†ç¸½é¡ -->
    <div class="card" style="background: #f9f9f9; border: 1px solid #e0e0e0;">
      <div class="info">
        <div class="price-label">ç‰¹åˆ¥æ–™ç†ç¸½æ•¸</div>
        <div style="font-size: 0.9rem; color: #999; margin-top: 4px;">
          $<span id="special-total">0</span>
        </div>
      </div>
      <div
        style="font-size: 1.3rem; font-weight: bold; color: var(--color-primary);"
      >
        <span id="special-count">0</span> ä»¶
      </div>
    </div>

    <!-- å…¶ä»–é‡‘é¡è¼¸å…¥ -->
    <div class="section-title">ğŸ¥¤ å…¶ä»–é …ç›®(ä»¥ä¸ŠMENUç„¡æ™‚äººæ‰‹è¼¸å…¥)</div>

    <div style="margin: 0 20px;">
      <div class="price-label">å…¶ä»–é …ç›®ï¼š</div>
      <div
        id="custom-items-list"
        style="margin-top: 10px; margin-bottom: 15px;"
      >
        <!-- å‹•æ…‹ç”Ÿæˆé …ç›® -->
      </div>
      <button class="add-item-btn" onclick="openCustomItemModal()">
        + æ–°å¢é …ç›®
      </button>
    </div>

    <!-- é‡ç½®æŒ‰éˆ• -->
    <div class="reset-container">
      <button class="reset-btn" onclick="resetAll()">å…¨éƒ¨é‡ç½®</button>
    </div>

    <!-- åº•éƒ¨çµç®—æ¬„ -->
    <div class="footer">
      <div class="total-row">
        <div>
          <div class="total-label">
            ç¸½é£Ÿç‰©æ•¸ç›®:
            <span
              id="total-plates"
              style="font-weight: bold; color: var(--color-text);"
              >0</span
            >
          </div>
          <div class="total-label">
            æ·¨é£Ÿç‰©ç¸½æ•¸: $<span id="subtotal">0</span>
          </div>
        </div>
        <div class="final-price-container">
          <div class="total-label" style="margin-bottom: 0;">é è¨ˆåŸ‹å–®åƒ¹éŒ¢</div>
          <div class="final-price">$<span id="grand-total">0</span></div>
        </div>
      </div>
      <div class="service-charge">(å·²åŒ…æ‹¬ 10% æœå‹™è²»ï¼Œé‡‘é¡åƒ…ä¾›åƒè€ƒ)</div>
    </div>

    <!-- ç‰¹åˆ¥æ–™ç† Modal -->
    <dialog id="specialDishesModal">
      <div class="modal-header">
        <h2>ç‰¹åˆ¥æ–™ç†menu</h2>
        <button
          class="modal-close"
          onclick="document.getElementById('specialDishesModal').close()"
        >
          âœ•
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </dialog>

    <script>
      // ğŸ”¹ è¨­å®šï¼šè«‹å°‡æ­¤è™•æ›æˆä½ çš„ Google Sheet CSV Link
      const SHEET_CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQW4KKDRzcAJFloxvEX1Da4BM4n7MWD6b7WxjbAfognnG0NNrnWNDDAqv3YPS8BqffuhrIg65pzCdof/pub?output=csv";

      // æ•¸æ“šçµæ§‹
      let counts = { red: 0, silver: 0, gold: 0, black: 0 };
      const prices = { red: 12, silver: 17, gold: 22, black: 27 };

      // é€™äº›è®Šæ•¸ç¾åœ¨æœƒå‹•æ…‹åŠ è¼‰
      let specialDishes = [];
      let specialCounts = {};
      let customItems = [];
      let customItemId = 0;

      // --- æ ¸å¿ƒåŠŸèƒ½ ---

      async function initApp() {
        await fetchMenu();
        calculateTotal();
      }

      async function fetchMenu() {
        try {
          const response = await fetch(SHEET_CSV_URL);
          if (!response.ok) throw new Error("Network response was not ok");
          const text = await response.text();
          specialDishes = parseCSV(text);

          // åˆå§‹åŒ–è¨ˆæ•¸å™¨
          specialDishes.forEach((dish) => {
            // å¦‚æœä¹‹å‰æœªæœ‰è¨˜éŒ„ï¼Œè¨­ç‚º 0ï¼›ä¿ç•™èˆŠè¨˜éŒ„ä»¥å…é‡åˆ·æ™‚æ¶ˆå¤±
            if (typeof specialCounts[dish.id] === "undefined") {
              specialCounts[dish.id] = 0;
            }
          });
          console.log("Menu loaded:", specialDishes);
        } catch (error) {
          console.error("ç„¡æ³•è¼‰å…¥èœå–®:", error);
          alert("è¼‰å…¥èœå–®å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ– Google Sheet è¨­å®šã€‚");
          // Fallback: å¦‚æœå¤±æ•—ï¼Œå¯ä»¥ä½¿ç”¨ç©ºé™£åˆ—æˆ–é è¨­æ•¸æ“š
          specialDishes = [];
        }
      }

      function parseCSV(csvText) {
        // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼ split æ›è¡Œç¬¦ï¼Œå…¼å®¹ Windows/Mac/Linux
        const lines = csvText.split(/\r\n|\n|\r/);
        const result = [];
        // å‡è¨­ç¬¬ä¸€è¡Œä¿‚æ¨™é¡Œï¼Œæ‰€ä»¥å¾ i = 1 é–‹å§‹
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          // ç°¡å–® CSV åˆ†å‰² (æ³¨æ„ï¼šèœåå…§ä¸èƒ½æœ‰é€—è™Ÿ)
          // æ ¼å¼: Category, Name, Price, ID
          const parts = line.split(",");
          if (parts.length >= 4) {
             // æ¸…ç†æ•¸æ“šï¼šå»é™¤é ­å°¾ç©ºç™½ï¼Œå»é™¤å¯èƒ½å­˜åœ¨çš„ CSV å¼•è™Ÿ
            const category = parts[0].trim().replace(/^"|"$/g, '');
            const name = parts[1].trim().replace(/^"|"$/g, '');
            const price = parseInt(parts[2].trim().replace(/^"|"$/g, ''));
            const id = parts[3].trim().replace(/^"|"$/g, '');

            if (name && !isNaN(price) && id) {
              result.push({ id, name, price, category });
            }
          }
        }
        return result;
      }

      function updateCount(type, change) {
        if (counts[type] + change < 0) return;
        counts[type] += change;
        document.getElementById(type + "-count").innerText = counts[type];
        calculateTotal();
        if (navigator.vibrate) navigator.vibrate(30);
      }

      function openCountInputModal(type) {
        const modal = document.createElement("div");
        modal.className = "count-input-modal";
        modal.id = "tempCountModal";

        const dialog = document.createElement("div");
        dialog.className = "count-input-dialog";

        const title = document.createElement("h3");
        title.textContent = "è¼¸å…¥æ•¸ç›®";

        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.value = counts[type];
        input.placeholder = "è¼¸å…¥æ•¸ç›®";

        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "count-input-buttons";

        const cancelBtn = document.createElement("button");
        cancelBtn.className = "btn-cancel";
        cancelBtn.textContent = "å–æ¶ˆ";
        cancelBtn.onclick = () => modal.remove();

        const confirmBtn = document.createElement("button");
        confirmBtn.className = "btn-confirm";
        confirmBtn.textContent = "ç¢ºèª";
        confirmBtn.onclick = () => {
          const newCount = parseInt(input.value) || 0;
          if (newCount < 0) return;
          counts[type] = newCount;
          document.getElementById(type + "-count").innerText = counts[type];
          calculateTotal();
          modal.remove();
          if (navigator.vibrate) navigator.vibrate(30);
        };

        buttonsDiv.appendChild(cancelBtn);
        buttonsDiv.appendChild(confirmBtn);

        dialog.appendChild(title);
        dialog.appendChild(input);
        dialog.appendChild(buttonsDiv);
        modal.appendChild(dialog);

        document.body.appendChild(modal);
        input.focus();
        input.select();
      }

      function openCustomItemModal() {
        const modal = document.createElement("div");
        modal.className = "count-input-modal";

        const dialog = document.createElement("div");
        dialog.className = "count-input-dialog";

        const title = document.createElement("h3");
        title.textContent = "è¼¸å…¥é …ç›®é‡‘é¡";

        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.placeholder = "è¼¸å…¥é‡‘é¡ (ä¾‹å¦‚: 30)";

        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "count-input-buttons";

        const cancelBtn = document.createElement("button");
        cancelBtn.className = "btn-cancel";
        cancelBtn.textContent = "å–æ¶ˆ";
        cancelBtn.onclick = () => modal.remove();

        const confirmBtn = document.createElement("button");
        confirmBtn.className = "btn-confirm";
        confirmBtn.textContent = "ç¢ºèª";
        confirmBtn.onclick = () => {
          const amount = parseFloat(input.value);
          if (isNaN(amount) || amount < 0) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡");
            return;
          }
          customItems.push({
            id: customItemId++,
            amount: amount,
          });
          renderCustomItems();
          calculateTotal();
          modal.remove();
          if (navigator.vibrate) navigator.vibrate(30);
        };

        buttonsDiv.appendChild(cancelBtn);
        buttonsDiv.appendChild(confirmBtn);

        dialog.appendChild(title);
        dialog.appendChild(input);
        dialog.appendChild(buttonsDiv);
        modal.appendChild(dialog);

        document.body.appendChild(modal);
        input.focus();
      }

      function deleteCustomItem(id) {
        customItems = customItems.filter((item) => item.id !== id);
        renderCustomItems();
        calculateTotal();
      }

      function renderCustomItems() {
        const listDiv = document.getElementById("custom-items-list");
        listDiv.innerHTML = "";

        customItems.forEach((item) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "custom-item";

          const infoDiv = document.createElement("div");
          infoDiv.className = "custom-item-info";

          const nameDiv = document.createElement("div");
          nameDiv.className = "custom-item-name";
          nameDiv.textContent = "é …ç›® " + (customItems.indexOf(item) + 1);

          const amountDiv = document.createElement("div");
          amountDiv.className = "custom-item-amount";
          amountDiv.textContent = "$" + item.amount.toFixed(0);

          infoDiv.appendChild(nameDiv);
          infoDiv.appendChild(amountDiv);

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "custom-item-delete";
          deleteBtn.textContent = "Ã—";
          deleteBtn.onclick = () => deleteCustomItem(item.id);

          itemDiv.appendChild(infoDiv);
          itemDiv.appendChild(deleteBtn);

          listDiv.appendChild(itemDiv);
        });
      }

      function updateSpecialDishCount(dishId, change) {
        if (specialCounts[dishId] + change < 0) return;
        specialCounts[dishId] += change;

        // æ›´æ–° modal ä¸­çš„é¡¯ç¤º
        const countDisplay = document.getElementById(dishId + "-count");
        if (countDisplay) countDisplay.innerText = specialCounts[dishId];

        calculateTotal();
        if (navigator.vibrate) navigator.vibrate(30);
      }

      function openSpecialDishesModal() {
        // å¦‚æœèœå–®æ˜¯ç©ºçš„ï¼Œå˜—è©¦é‡æ–°è¼‰å…¥
        if (specialDishes.length === 0) {
          fetchMenu().then(() => {
            if (specialDishes.length > 0) openSpecialDishesModal();
          });
          return;
        }

        const modalBody = document.getElementById("modalBody");
        modalBody.innerHTML = "";

        // å–å¾—æ‰€æœ‰ä¸é‡è¤‡çš„ category
        const categories = [
          ...new Set(specialDishes.map((item) => item.category)),
        ];

        categories.forEach((category) => {
          const categoryDishes = specialDishes.filter(
            (d) => d.category === category
          );
          if (categoryDishes.length === 0) return;

          // åˆ†é¡æ¨™é¡Œ
          const categoryDiv = document.createElement("div");
          categoryDiv.className = "modal-category";
          categoryDiv.textContent = category;
          modalBody.appendChild(categoryDiv);

          // è©²åˆ†é¡ä¸‹çš„èœé …
          categoryDishes.forEach((dish) => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "modal-item";
            itemDiv.innerHTML = `
                        <div class="modal-item-info">
                            <div class="modal-item-name">${dish.name}</div>
                            <div class="modal-item-price">$${dish.price}</div>
                        </div>
                        <div class="modal-item-controls">
                            <button class="small-btn small-btn-minus" onclick="updateSpecialDishCount('${
                              dish.id
                            }', -1)">âˆ’</button>
                            <div class="modal-item-count" id="${
                              dish.id
                            }-count">${specialCounts[dish.id]}</div>
                            <button class="small-btn small-btn-plus" onclick="updateSpecialDishCount('${
                              dish.id
                            }', 1)">+</button>
                        </div>
                    `;
            modalBody.appendChild(itemDiv);
          });
        });

        document.getElementById("specialDishesModal").showModal();
      }

      function calculateTotal() {
        // è¨ˆç®—ç¢Ÿå­ç¸½é¡
        let foodTotal =
          counts.red * prices.red +
          counts.silver * prices.silver +
          counts.gold * prices.gold +
          counts.black * prices.black;

        // è¨ˆç®—ç¢Ÿå­ç¸½æ•¸
        let totalPlates =
          counts.red + counts.silver + counts.gold + counts.black;

        // è¨ˆç®—ç‰¹åˆ¥æ–™ç†ç¸½é¡å’Œè¨ˆæ•¸
        let specialTotal = 0;
        let specialCount = 0;
        specialDishes.forEach((dish) => {
          if (specialCounts[dish.id]) {
            specialTotal += specialCounts[dish.id] * dish.price;
            specialCount += specialCounts[dish.id];
          }
        });

        foodTotal += specialTotal;

        // åŠ ä¸Šè‡ªè¨‚é …ç›®çš„é‡‘é¡
        let customTotal = 0;
        customItems.forEach((item) => {
          customTotal += item.amount;
        });
        foodTotal += customTotal;

        // è¨ˆç®—åŠ æœå‹™è²»
        let grandTotal = Math.round(foodTotal * 1.1);

        // æ›´æ–°ç•«é¢
        document.getElementById("total-plates").innerText = totalPlates + specialCount;
        document.getElementById("special-count").innerText = specialCount;
        document.getElementById("special-total").innerText = specialTotal;
        document.getElementById("subtotal").innerText = foodTotal;
        document.getElementById("grand-total").innerText = grandTotal;
      }

      function resetAll() {
        if (!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„é‡æ–°è¨ˆç®—å—ï¼Ÿ")) return;

        console.log("é–‹å§‹é‡ç½®...");

        counts = { red: 0, silver: 0, gold: 0, black: 0 };
        document.getElementById("red-count").textContent = "0";
        document.getElementById("silver-count").textContent = "0";
        document.getElementById("gold-count").textContent = "0";
        document.getElementById("black-count").textContent = "0";

        for (let key in specialCounts) {
          specialCounts[key] = 0;
        }

        customItems = [];
        customItemId = 0;
        renderCustomItems();
        calculateTotal();

        console.log("é‡ç½®å®Œæˆï¼");
      }

      // é—œé–‰ modal æ™‚è‡ªå‹•è¨ˆç®—
      document
        .getElementById("specialDishesModal")
        .addEventListener("close", calculateTotal);

      // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
      initApp();
    </script>
  </body>
</html>
